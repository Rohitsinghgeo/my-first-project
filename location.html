<script>
require([
  "esri/layers/FeatureLayer",
  "esri/geometry/Point",
  "esri/identity/OAuthInfo",
  "esri/identity/IdentityManager"
], function (FeatureLayer, Point, OAuthInfo, IdentityManager) {

  const oauthInfo = new OAuthInfo({
    appId: "eTivrXGOGm2NxME8",
    portalUrl: "https://www.arcgis.com",
    popup: false
  });

  IdentityManager.registerOAuthInfos([oauthInfo]);
  IdentityManager.getCredential("https://www.arcgis.com/sharing");

  const layer = new FeatureLayer({
    url: "https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0",
    outFields: ["*"]
  });

  const btn = document.getElementById("submitBtn");
  const status = document.getElementById("status");

  btn.onclick = function () {
    const siteName = document.getElementById("siteName").value.trim();
    const remarks = document.getElementById("remarks").value.trim();
    const photo = document.getElementById("photo").files[0];

    if (!siteName || !photo) {
      alert("Site Name aur Photo required hai");
      return;
    }

    btn.disabled = true;
    status.innerHTML = "üìç Location le rahe hain...";

    navigator.geolocation.getCurrentPosition(
      function (pos) {

        const point = new Point({
          longitude: pos.coords.longitude,
          latitude: pos.coords.latitude
        });

        status.innerHTML = "üì§ Feature save ho raha hai...";

        layer.applyEdits({
          addFeatures: [{
            geometry: point,
            attributes: {
              Site_Name: siteName,
              Remarks: remarks,
              Upload_Date: new Date()
            }
          }]
        }).then(function (res) {

          const oid = res.addFeatureResults[0].objectId;

          status.innerHTML = "üì∏ Photo upload ho rahi hai...";

          layer.addAttachment({
            objectId: oid,
            attachment: photo
          }).then(function () {
            status.innerHTML = "‚úÖ Feature + Photo upload successful";
            btn.disabled = false;
          });

        });

      },
      function () {
        alert("GPS permission allow karo");
        btn.disabled = false;
      }
    );
  };

});
</script>
