<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<title>SITE_LOCATION ‚Äì Camera Survey</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  margin: 0;
  min-height: 100vh;
  background:
    linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55)),
    url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee');
  background-size: cover;
  background-position: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.box {
  background: #fff;
  width: 100%;
  max-width: 420px;
  padding: 18px;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

h2 {
  text-align: center;
  font-size: 17px;
  color: #003b5c;
  margin-bottom: 10px;
  line-height: 1.4;
}

.field-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

input, select {
  width: 100%;
  padding: 9px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.full { grid-column: span 2; }

button {
  width: 100%;
  padding: 11px;
  margin-top: 8px;
  font-size: 15px;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  background: linear-gradient(135deg, #0079c1, #005e95);
  color: #fff;
}

button.secondary {
  background: #444;
}

#mapDiv {
  height: 0;
  margin-top: 10px;
  border-radius: 10px;
  overflow: hidden;
  transition: height 0.3s ease;
}

#status {
  margin-top: 8px;
  text-align: center;
  font-size: 13px;
  font-weight: bold;
}

.footer {
  margin-top: 12px;
  text-align: center;
  border-top: 1px solid #ddd;
  padding-top: 8px;
}

.footer img {
  height: 36px;
}

.footer-text {
  font-size: 12px;
  font-weight: bold;
  color: #003b5c;
}
</style>
</head>

<body>

<div class="box">
<h2>KALPATARU PROJECTS<br>SITE SURVEY</h2>

<!-- üîê CAMERA PERMISSION -->
<button id="cameraPermissionBtn" class="secondary">
üì∑ Allow Camera Access
</button>

<small style="display:block;text-align:center;color:#555;margin-top:4px;">
Camera access allow karna zaroori hai
</small>

<div class="field-group" style="margin-top:8px;">
  <input id="CLUSTER" placeholder="Cluster">
  <input id="SITENAME" placeholder="Site Name">

  <input type="date" id="DATE">
  <input id="COMPONENTS" placeholder="Components">

  <input id="SUB_COMPONENTS" placeholder="Sub Components" class="full">
  <input id="REMARKS" placeholder="Remarks" class="full">

  <!-- CAMERA ONLY -->
  <input type="file"
         id="photo"
         accept="image/*"
         capture="environment"
         class="full">

  <!-- BASEMAP -->
  <select id="basemapSelect" class="full">
    <option value="streets-navigation-vector">Streets</option>
    <option value="satellite">Satellite</option>
    <option value="hybrid">Hybrid</option>
    <option value="topo-vector">Terrain</option>
    <option value="osm">OpenStreetMap</option>
  </select>
</div>

<button onclick="previewLocation()">üó∫Ô∏è Preview Location</button>
<button onclick="uploadData()">‚¨Ü Upload Data</button>

<div id="mapDiv"></div>
<div id="status"></div>

<div class="footer">
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Kalpataru_logo.svg/1024px-Kalpataru_logo.svg.png">
  <div class="footer-text">KALPATARU WATER TEAM</div>
</div>
</div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/geometry/Point",
  "esri/Graphic",
  "esri/request"
], function (Map, MapView, Point, Graphic, esriRequest) {

const featureUrl =
"https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0";

let currentGPS = null;
let cameraAllowed = false;

/* üîê CAMERA PERMISSION */
document.getElementById("cameraPermissionBtn").addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    stream.getTracks().forEach(t => t.stop());
    cameraAllowed = true;

    alert("‚úÖ Camera access allowed");
  } catch {
    cameraAllowed = false;
    alert("‚ùå Camera access denied");
  }
});

/* üó∫Ô∏è MAP INIT (page load) */
const map = new Map({ basemap: "streets-navigation-vector" });

const view = new MapView({
  container: "mapDiv",
  map: map,
  center: [77, 28],
  zoom: 5
});

/* BASEMAP CHANGE */
document.getElementById("basemapSelect").addEventListener("change", e => {
  map.basemap = e.target.value;
});

/* LIVE GPS */
function getLiveGPS() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      pos => resolve({
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
      }),
      () => reject()
    );
  });
}

/* PREVIEW */
window.previewLocation = async function () {
  if (!cameraAllowed) {
    alert("Pehle 'Allow Camera Access' dabao");
    return;
  }

  const status = document.getElementById("status");
  status.innerText = "üìç Getting live GPS...";

  try {
    currentGPS = await getLiveGPS();
  } catch {
    alert("‚ùå GPS allow nahi hai");
    return;
  }

  document.getElementById("mapDiv").style.height = "230px";

  view.center = [currentGPS.longitude, currentGPS.latitude];
  view.zoom = 18;

  view.graphics.removeAll();
  view.graphics.add(new Graphic({
    geometry: new Point(currentGPS),
    symbol: { type: "simple-marker", color: "red", size: 12 }
  }));

  view.resize();
  status.innerText = "üó∫Ô∏è Location preview ready";
};

/* UPLOAD */
window.uploadData = async function () {
  if (!cameraAllowed) {
    alert("Camera access required");
    return;
  }

  if (!currentGPS) {
    alert("Pehle Preview Location karo");
    return;
  }

  const file = document.getElementById("photo").files[0];
  if (!file) {
    alert("Camera se photo lo");
    return;
  }

  const point = new Point({
    latitude: currentGPS.latitude,
    longitude: currentGPS.longitude,
    spatialReference: { wkid: 4326 }
  });

  const attributes = {
    CLUSTER: CLUSTER.value || "",
    SITENAME: SITENAME.value || "",
    DATE_: DATE.value || "",
    COMPONENTS: COMPONENTS.value || "",
    SUB_COMPONENTS: SUB_COMPONENTS.value || "",
    REMARKS: REMARKS.value || ""
  };

  const res = await esriRequest(featureUrl + "/addFeatures", {
    method: "post",
    query: {
      f: "json",
      features: JSON.stringify([{ geometry: point, attributes }])
    }
  });

  const oid = res.data.addResults[0].objectId;

  const fd = new FormData();
  fd.append("attachment", file);
  fd.append("f", "json");

  await fetch(`${featureUrl}/${oid}/addAttachment`, {
    method: "POST",
    body: fd
  });

  document.getElementById("status").innerText =
    "‚úÖ Photo & Data Uploaded Successfully";
};
});
</script>

</body>
</html>
