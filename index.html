<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
 content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>SITE_LOCATION ‚Äì GIS Field Survey</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  font-family: Arial, sans-serif;
  background:
    linear-gradient(rgba(0,0,0,.55), rgba(0,0,0,.55)),
    url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee');
  background-size: cover;
  display: flex;
  align-items: center;
  justify-content: center;
}

.box {
  background: #fff;
  width: 100%;
  max-width: 420px;
  padding: 16px;
  border-radius: 14px;
}

h2 {
  text-align: center;
  font-size: 16px;
  color: #003b5c;
}

.field-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

input {
  width: 100%;
  padding: 9px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.full { grid-column: span 2; }

button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  font-size: 14px;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  background: linear-gradient(135deg, #0079c1, #005e95);
  color: #fff;
}

.secondary { background: #555; }

#status, #offlineCount {
  margin-top: 6px;
  text-align: center;
  font-size: 13px;
  font-weight: bold;
}

#offlineList {
  margin-top: 8px;
  display: none;
  max-height: 150px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px;
  font-size: 12px;
}
.offline-item {
  border-bottom: 1px dashed #ccc;
  padding: 4px 0;
}
</style>
</head>

<body>
<div class="box">

<h2>KALPATARU PROJECTS<br>SITE SURVEY</h2>

<div class="field-group">
  <input id="CLUSTER" placeholder="CLUSTER">
  <input id="SITE_NAME" placeholder="SITE_NAME">
  <input type="DATE" id="DATE">
  <input id="COMPONENTS" placeholder="COMPONENTS">
  <input id="SUBCOMPONENTS" class="full" placeholder="SUBCOMPONENTS">
  <input id="PROJECT" class="full" placeholder="PROJECT">
  <input id="REMARKS" class="full" placeholder="Remarks">
</div>

<button onclick="capturePhoto()">üì∏ Capture Photo</button>
<button onclick="previewLocation()">üó∫Ô∏è Preview Location</button>
<button onclick="uploadData()">‚¨Ü Upload / Save</button>
<button onclick="syncOfflineData()" class="secondary">üîÑ Sync Offline Data</button>
<button onclick="toggleOfflineList()" class="secondary">üìÇ View Offline Records</button>

<div id="offlineCount">Offline Records: 0</div>
<div id="offlineList"></div>

<div id="status"></div>

</div>

<script>
require([
  "esri/geometry/Point",
  "esri/request"
], function (Point, esriRequest) {

const FEATURE_URL =
"https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0";

let gpsPoint = null;
let photoBase64 = null;

/* PHOTO */
window.capturePhoto = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  const video = document.createElement("video");
  video.srcObject = stream;
  await video.play();

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  stream.getTracks().forEach(t => t.stop());

  photoBase64 = canvas.toDataURL("image/jpeg", 0.7);
  status.innerText = "üì∏ Photo captured";
};

/* GPS */
window.previewLocation = async () => {
  navigator.geolocation.getCurrentPosition(p => {
    gpsPoint = {
      latitude: p.coords.latitude,
      longitude: p.coords.longitude,
      accuracy: Math.round(p.coords.accuracy)
    };
    status.innerText = "üìç GPS Accuracy: " + gpsPoint.accuracy + " m";
  });
};

/* OFFLINE COUNT */
function updateOfflineCount() {
  const list = JSON.parse(localStorage.getItem("offlineSites") || "[]");
  offlineCount.innerText = "Offline Records: " + list.length;
}
updateOfflineCount();

/* SAVE OFFLINE */
function saveOffline(data) {
  let list = JSON.parse(localStorage.getItem("offlineSites") || "[]");
  list.push(data);
  localStorage.setItem("offlineSites", JSON.stringify(list));
  updateOfflineCount();
}

/* UPLOAD */
window.uploadData = async () => {

  const record = {
    attributes: {
      CLUSTER: CLUSTER.value,
      SITE_NAME: SITE_NAME.value,
      DATE: DATE.value,
      COMPONENTS: COMPONENTS.value,
      SUBCOMPONENTS: SUBCOMPONENTS.value,
      PROJECT: PROJECT.value,
      REMARKS: REMARKS.value
    },
    gpsPoint,
    photoBase64,
    time: new Date().toLocaleString()
  };

  if (!navigator.onLine) {
    saveOffline(record);
    status.innerText = "üì¥ No Internet ‚Äì Saved Offline";
    return;
  }

  await uploadSingle(record);
  status.innerText = "‚úÖ Uploaded Successfully";
};

/* LIST VIEW */
window.toggleOfflineList = () => {
  const box = document.getElementById("offlineList");
  const list = JSON.parse(localStorage.getItem("offlineSites") || "[]");

  if (box.style.display === "block") {
    box.style.display = "none";
    return;
  }

  box.innerHTML = "";
  list.forEach((r, i) => {
    box.innerHTML += `
      <div class="offline-item">
        <b>${i+1}. ${r.attributes.SITE_NAME || "No Name"}</b><br>
        ${r.time}<br>
        Lat: ${r.gpsPoint.latitude.toFixed(5)},
        Lon: ${r.gpsPoint.longitude.toFixed(5)}
      </div>`;
  });

  box.style.display = "block";
};

/* SYNC */
window.syncOfflineData = async () => {
  if (!navigator.onLine) return alert("No Internet");

  let list = JSON.parse(localStorage.getItem("offlineSites") || "[]");
  for (let r of list) await uploadSingle(r);

  localStorage.removeItem("offlineSites");
  updateOfflineCount();
  offlineList.style.display = "none";
  status.innerText = "‚úÖ Offline data synced";
};

async function uploadSingle(r) {
  const pt = new Point({
    latitude: r.gpsPoint.latitude,
    longitude: r.gpsPoint.longitude
  });

  const addRes = await esriRequest(FEATURE_URL + "/addFeatures", {
    method: "post",
    query: {
      f: "json",
      features: JSON.stringify([{ geometry: pt, attributes: r.attributes }])
    }
  });

  const oid = addRes.data.addResults[0].objectId;

  const blob = await fetch(r.photoBase64).then(r => r.blob());
  const fd = new FormData();
  fd.append("attachment", blob, "photo.jpg");
  fd.append("f", "json");

  await fetch(FEATURE_URL + "/" + oid + "/addAttachment", {
    method: "POST",
    body: fd
  });
}

/* AUTO SYNC */
window.addEventListener("online", syncOfflineData);

});
</script>
</body>
</html>
