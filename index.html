<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SITE LOCATION Upload</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { margin: 6px 0; width: 250px; }
  </style>
</head>

<body>

<h2>SITE LOCATION FORM</h2>

<input type="text" id="siteName" placeholder="Site Name" /><br>
<input type="text" id="remarks" placeholder="Remarks" /><br>
<input type="file" id="photo" accept="image/*" /><br>
<button id="submitBtn">Submit</button>

<script>
require([
  "esri/portal/Portal",
  "esri/layers/FeatureLayer",
  "esri/identity/OAuthInfo",
  "esri/identity/IdentityManager"
], function (Portal, FeatureLayer, OAuthInfo, esriId) {

  // üîê OAuth
  const oauthInfo = new OAuthInfo({
    appId: "eTivrXGOGm2NxME8",
    portalUrl: "https://www.arcgis.com",
    popup: false
  });
  esriId.registerOAuthInfos([oauthInfo]);

  esriId.getCredential("https://www.arcgis.com");

  const portal = new Portal();
  portal.load();

  const layer = new FeatureLayer({
    url: "https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0"
  });

  document.getElementById("submitBtn").onclick = async function () {

    const siteName = document.getElementById("siteName").value;
    const remarks = document.getElementById("remarks").value;
    const photoFile = document.getElementById("photo").files[0];

    if (!photoFile) {
      alert("Please select photo");
      return;
    }

    // üìç Dummy point (change if needed)
    const point = {
      type: "point",
      longitude: 77,
      latitude: 28
    };

    // ‚úÖ STEP 1: ADD FEATURE
    const addResult = await layer.applyEdits({
      addFeatures: [{
        geometry: point,
        attributes: {
          SITE_NAME: siteName,
          REMARKS: remarks
        }
      }]
    });

    const objectId = addResult.addFeatureResults[0].objectId;

    // ‚úÖ STEP 2: ADD ATTACHMENT
    const formData = new FormData();
    formData.append("attachment", photoFile);
    formData.append("f", "json");
    formData.append("token", esriId.credentials[0].token);

    await fetch(
      `https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0/${objectId}/addAttachment`,
      {
        method: "POST",
        body: formData
      }
    );

    alert("‚úÖ Feature + Photo uploaded successfully");
  };
});
</script>

</body>
</html>
