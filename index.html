<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SITE_LOCATION ‚Äì Photo Upload</title>

  <!-- ArcGIS JS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    .box {
      background: #fff;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    button {
      background: #0079c1;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #005e95;
    }
  </style>
</head>

<body>

<div class="box">
  <h2>SITE LOCATION ‚Äì Photo Upload</h2>

  <input type="text" id="siteName" placeholder="Site Name" />
  <input type="text" id="remarks" placeholder="Remarks" />
  <input type="file" id="photo" accept="image/*" />
  <button onclick="uploadData()">Upload</button>

  <p id="status"></p>
</div>

<script>
require([
  "esri/geometry/Point",
  "esri/request"
], function (Point, esriRequest) {

  const featureUrl =
    "https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0";

  // üîπ DMS ‚Üí Decimal (AUTO FIX)
  function dmsToDecimal(deg, min, sec, dir) {
    let d = Math.abs(deg);
    let m = Math.abs(min);
    let s = Math.abs(sec);

    // Normalize (important for your photos)
    m += Math.floor(s / 60);
    s = s % 60;
    d += Math.floor(m / 60);
    m = m % 60;

    let dec = d + (m / 60) + (s / 3600);
    if (dir === "S" || dir === "W") dec *= -1;
    return dec;
  }

  // üîπ Read GPS from image
  function readGPS(file) {
    return new Promise((resolve, reject) => {
      EXIF.getData(file, function () {
        const lat = EXIF.getTag(this, "GPSLatitude");
        const lon = EXIF.getTag(this, "GPSLongitude");
        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

        if (!lat || !lon) {
          reject("GPS data not found in photo");
          return;
        }

        const latitude = dmsToDecimal(lat[0], lat[1], lat[2], latRef);
        const longitude = dmsToDecimal(lon[0], lon[1], lon[2], lonRef);

        resolve({ latitude, longitude });
      });
    });
  }

  window.uploadData = async function () {
    const siteName = document.getElementById("siteName").value;
    const remarks = document.getElementById("remarks").value;
    const fileInput = document.getElementById("photo");
    const status = document.getElementById("status");

    if (!fileInput.files.length) {
      alert("Photo select karo");
      return;
    }

    status.innerText = "Reading GPS from photo...";

    try {
      const gps = await readGPS(fileInput.files[0]);

      const point = new Point({
        longitude: gps.longitude,
        latitude: gps.latitude,
        spatialReference: { wkid: 4326 }
      });

      // üîπ Add feature
      const addFeatureResponse = await esriRequest(
        featureUrl + "/addFeatures",
        {
          method: "post",
          query: {
            f: "json",
            features: JSON.stringify([{
              geometry: point,
              attributes: {
                SITE_NAME: siteName,
                REMARKS: remarks
              }
            }])
          }
        }
      );

      const objectId =
        addFeatureResponse.data.addResults[0].objectId;

      // üîπ Add attachment
      const formData = new FormData();
      formData.append("attachment", fileInput.files[0]);
      formData.append("f", "json");

      await fetch(
        `${featureUrl}/${objectId}/addAttachment`,
        {
          method: "POST",
          body: formData
        }
      );

      status.innerText = "‚úÖ Data + Photo uploaded successfully!";
      fileInput.value = "";
    }
    catch (err) {
      console.error(err);
      status.innerText = "‚ùå Error: " + err;
    }
  };
});
</script>

<!-- EXIF LIB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

</body>
</html>
