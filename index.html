<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Professional Offline GIS Survey</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  font-family:Segoe UI, Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  display:flex;
  justify-content:center;
  align-items:center;
}

.box{
  background:#fff;
  width:100%;
  max-width:420px;
  padding:16px;
  border-radius:18px;
  box-shadow:0 15px 40px rgba(0,0,0,.35);
}

h2{
  text-align:center;
  font-size:17px;
  color:#0b3c5d;
  margin-bottom:10px;
}

input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

button{
  border:none;
  cursor:pointer;
  font-weight:600;
  background:#005bea;
  color:#fff;
}

.secondary{background:#4b5563}
.success{background:#28a745}

#map{
  height:220px;
  margin-top:8px;
  border-radius:12px;
}

video{
  width:100%;
  display:none;
  border-radius:12px;
  margin-top:6px;
}

#status{
  margin-top:8px;
  padding:6px;
  border-radius:8px;
  background:#eef2f7;
  font-size:13px;
  font-weight:600;
  text-align:center;
}
</style>
</head>

<body>

<div class="box">

<h2>OFFLINE GIS FIELD SURVEY</h2>

<input id="site" placeholder="SITE NAME">
<input id="project" placeholder="PROJECT">
<input id="remarks" placeholder="REMARKS">

<button onclick="startCamera()" class="secondary">ğŸ“· Start Camera</button>
<button onclick="capturePhoto()">ğŸ“¸ Capture Photo</button>
<video id="video" autoplay playsinline></video>

<button onclick="getLocation()">ğŸ“ Get Location</button>

<div id="map"></div>

<button onclick="saveRecord()">ğŸ’¾ Save Offline</button>
<button onclick="syncData()" class="secondary">ğŸ”„ Sync Online</button>

<div id="status">Ready</div>

</div>

<script>
/* ================= MAP (100% OFFLINE) ================= */
const map = L.map('map').setView([29.8,76.7],16);

L.tileLayer('tiles/{z}/{x}/{y}.png',{
  minZoom:12,
  maxZoom:19
}).addTo(map);

let marker;
function showPoint(lat,lon){
  if(marker) map.removeLayer(marker);
  marker = L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],18);
}

/* ================= CAMERA ================= */
let stream=null, photoBase64=null;

function startCamera(){
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
  .then(s=>{
    stream=s;
    video.srcObject=s;
    video.style.display="block";
  });
}

function capturePhoto(){
  if(!stream){alert("Camera ON karo");return;}
  const c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  photoBase64=c.toDataURL("image/jpeg",0.7);
  stream.getTracks().forEach(t=>t.stop());
  video.style.display="none";
  status.innerText="ğŸ“¸ Photo captured";
}

/* ================= GPS ================= */
let lat=null, lon=null;

function getLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    lat=p.coords.latitude;
    lon=p.coords.longitude;
    showPoint(lat,lon);
    status.innerText="ğŸ“ Location fixed";
  },()=>alert("GPS error"));
}

/* ================= INDEXEDDB ================= */
let db;
const req=indexedDB.open("OfflineGIS",1);

req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("records",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>db=e.target.result;

function saveDB(data){
  const tx=db.transaction("records","readwrite");
  tx.objectStore("records").add(data);
}

function getAllDB(cb){
  const tx=db.transaction("records","readonly");
  const r=tx.objectStore("records").getAll();
  r.onsuccess=()=>cb(r.result);
}

function deleteDB(id){
  const tx=db.transaction("records","readwrite");
  tx.objectStore("records").delete(id);
}

/* ================= SAVE OFFLINE ================= */
function saveRecord(){
  if(!photoBase64||!lat){alert("Photo & Location required");return;}

  saveDB({
    site:site.value,
    project:project.value,
    remarks:remarks.value,
    lat,lon,
    photo:photoBase64,
    time:new Date().toLocaleString()
  });

  status.innerText="ğŸ’¾ Saved Offline";
}

/* ================= SYNC ================= */
function syncData(){
  if(!navigator.onLine){alert("No Internet");return;}

  getAllDB(list=>{
    list.forEach(r=>{
      console.log("UPLOAD TO SERVER",r); // ArcGIS / API
      deleteDB(r.id);
    });
    status.innerText="âœ… Synced Successfully";
  });
}

/* ================= SERVICE WORKER ================= */
if("serviceWorker" in navigator){
  const swCode=`
  self.addEventListener("install",e=>{
    e.waitUntil(
      caches.open("offline-gis").then(c=>c.addAll(["./"]))
    );
  });
  self.addEventListener("fetch",e=>{
    e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
  });
  `;
  const blob=new Blob([swCode],{type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}
</script>

</body>
</html>
