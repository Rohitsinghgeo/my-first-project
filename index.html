<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SITE_LOCATION ‚Äì Photo Upload</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  padding:10px;
}
.box{
  background:#fff;
  max-width:550px;
  margin:auto;
  padding:20px;
  border-radius:10px;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:8px;
}
#mapDiv{
  height:250px;
  margin-top:10px;
  display:none;
}
#status{
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="box">
<h3>SITE SURVEY</h3>

<input id="CLUSTER" placeholder="Cluster">
<input id="SITENAME" placeholder="Site Name">
<input type="date" id="DATE">
<input id="COMPONENTS" placeholder="Components">
<input id="SUB_COMPONENTS" placeholder="Sub Components">
<input id="REMARKS" placeholder="Remarks">

<!-- Camera + Gallery -->
<input type="file" id="photo" accept="image/*">

<div id="mapDiv"></div>

<button onclick="previewAndUpload()">Preview Location & Upload</button>

<div id="status"></div>
</div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/geometry/Point",
  "esri/Graphic",
  "esri/request"
], function(Map, MapView, Point, Graphic, esriRequest){

const featureUrl =
"https://services.arcgis.com/NJ6dRODVurthn1U5/arcgis/rest/services/SITE_LOCATION/FeatureServer/0";

let view;

function rejectBadPhotos(file){
  const name = file.name.toLowerCase();
  if(
    name.includes("screenshot") ||
    name.includes("whatsapp")
  ){
    return true;
  }
  return false;
}

function dmsToDecimal(d,m,s,ref){
  let dec = d + m/60 + s/3600;
  return (ref==="S"||ref==="W")?-dec:dec;
}

function readGPS(file){
  return new Promise((res,rej)=>{
    EXIF.getData(file,function(){
      const lat = EXIF.getTag(this,"GPSLatitude");
      const lon = EXIF.getTag(this,"GPSLongitude");
      const latRef = EXIF.getTag(this,"GPSLatitudeRef");
      const lonRef = EXIF.getTag(this,"GPSLongitudeRef");
      if(!lat||!lon) rej();
      res({
        latitude:dmsToDecimal(lat[0],lat[1],lat[2],latRef),
        longitude:dmsToDecimal(lon[0],lon[1],lon[2],lonRef)
      });
    });
  });
}

function getLiveGPS(){
  return new Promise((res,rej)=>{
    navigator.geolocation.getCurrentPosition(
      p=>res({latitude:p.coords.latitude,longitude:p.coords.longitude}),
      ()=>rej()
    );
  });
}

window.previewAndUpload = async function(){
  const status = document.getElementById("status");
  const file = document.getElementById("photo").files[0];
  if(!file){ alert("Photo select karo"); return; }

  // ‚ùå Reject screenshots / WhatsApp
  if(rejectBadPhotos(file)){
    alert("‚ùå Screenshot / WhatsApp photo allowed nahi hai");
    return;
  }

  let gps=null;
  try{ gps=await readGPS(file); }
  catch{
    try{ gps=await getLiveGPS(); }
    catch{
      alert("‚ùå GPS nahi mila. Upload cancel.");
      return;
    }
  }

  // üó∫Ô∏è MAP PREVIEW
  document.getElementById("mapDiv").style.display="block";
  const map = new Map({ basemap:"streets-navigation-vector" });
  view = new MapView({
    container:"mapDiv",
    map:map,
    center:[gps.longitude,gps.latitude],
    zoom:18
  });

  view.graphics.add(new Graphic({
    geometry:new Point({longitude:gps.longitude,latitude:gps.latitude}),
    symbol:{
      type:"simple-marker",
      color:"red",
      size:12
    }
  }));

  // ‚¨Ü Upload after preview
  const point = new Point({
    latitude:gps.latitude,
    longitude:gps.longitude,
    spatialReference:{wkid:4326}
  });

  const attributes={
    CLUSTER:CLUSTER.value||"",
    SITENAME:SITENAME.value||"",
    DATE_:DATE.value||"",
    COMPONENTS:COMPONENTS.value||"",
    SUB_COMPONENTS:SUB_COMPONENTS.value||"",
    REMARKS:REMARKS.value||""
  };

  const addRes = await esriRequest(featureUrl+"/addFeatures",{
    method:"post",
    query:{
      f:"json",
      features:JSON.stringify([{geometry:point,attributes}])
    }
  });

  const oid = addRes.data.addResults[0].objectId;

  const fd = new FormData();
  fd.append("attachment",file);
  fd.append("f","json");

  await fetch(`${featureUrl}/${oid}/addAttachment`,{
    method:"POST",
    body:fd
  });

  status.innerHTML="‚úÖ Location previewed & uploaded successfully";
};
});
</script>

</body>
</html>
